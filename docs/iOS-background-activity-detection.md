# Определение активности в фоне на iOS

## Проблема

На iOS приложение в фоне не определяло смену состояния движения: едет, стоит или идёт.

## Анализ причин

### 1. Зависимость только от GPS-скорости

Исходная реализация `ActivityProviderImpl` определяла состояние (still/walking/inVehicle) **исключительно по скорости из GPS** (`updateFromSpeed(location.speed)`).

На iOS в фоне:
- Обновления геолокации приходят редко или с задержкой
- `distanceFilter` (50 м в idle) означает, что при стоянии обновлений почти нет
- Без обновлений локации нет скорости → нет смены состояния

### 2. Отсутствие CMMotionActivityManager

В плане реализации предполагалось использование CMMotionActivityManager (Core Motion) на iOS, но фактически использовался только GPS.

CMMotionActivityManager:
- Работает на отдельном motion-сопроцессоре
- Определяет stationary, walking, running, automotive
- При пробуждении приложения (например, по обновлению геолокации) доставляет накопленные обновления

### 3. Ограничения iOS в фоне

- CMMotionActivityManager не доставляет обновления, пока приложение приостановлено
- При пробуждении по геолокации приложение получает и обновления локации, и накопленные обновления активности
- Важно: обновления геолокации должны периодически «будить» приложение

## Реализованные доработки

### 1. Гибридный ActivityProvider (`ActivityProviderHybrid`)

- **iOS/Android**: нативное распознавание через `flutter_activity_recognition` (CMMotionActivityManager на iOS, ActivityRecognition на Android)
- **Fallback**: определение по скорости GPS, если нативное API недоступно
- **Дополнение**: при скорости > 5 м/с (~18 км/ч) принудительно считаем `inVehicle`, даже если нативное API ещё не обновилось

### 2. NSMotionUsageDescription в Info.plist

Добавлено описание использования Motion & Fitness для доступа к CMMotionActivityManager.

### 3. Разрешение ACTIVITY_RECOGNITION на Android

Добавлено в AndroidManifest.xml для работы ActivityRecognition.

### 4. Настройки LocationProvider для iOS

- В режиме idle на iOS уменьшен `distanceFilter` с 50 м до 20 м
- Это даёт более частые пробуждения приложения при движении и позволяет получать обновления от CMMotionActivityManager

## Рекомендации по тестированию

1. **Разрешения**: при первом запуске подтвердить доступ к Motion & Fitness (для распознавания активности).
2. **Фон**: перевести приложение в фон, затем сменить активность (стоять → идти → сесть в машину).
3. **Логи**: в консоли должны появляться сообщения `[ActivityProvider] Native update: ...` при смене состояния.

## Дополнительные улучшения (опционально)

1. **Передача confidence в StateMachine** — сейчас используется фиксированное 0.6; можно передавать реальную уверенность из нативного API.
2. **Периодический опрос при длительном стоянии** — если пользователь стоит долго, обновления геолокации редки; можно рассмотреть использование significant location changes для редких пробуждений.
3. **flutter_foreground_task** — для более стабильной работы в фоне на iOS можно рассмотреть использование foreground task (постоянное уведомление), как рекомендует документация flutter_activity_recognition.
